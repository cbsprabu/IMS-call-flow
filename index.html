<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IMS Call Flow - 3D Edition</title>
  <style>
    :root {
      --primary: #0066cc;
      --primary-light: #e6f2ff;
      --primary-dark: #004499;
      --success: #10b981;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #94a3b8;
      --border: #e2e8f0;
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow-md);
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 280px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .sidebar h2 {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: 1rem;
    }

    .flow-selector select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 2rem;
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .timeline-item {
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      border-left: 3px solid transparent;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .timeline-item.completed {
      border-left-color: var(--success);
      background: #f0fdf4;
      color: #166534;
    }

    .timeline-item.active {
      border-left-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      gap: 1rem;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--primary);
    }

    .btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn.primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .diagram-wrapper {
      flex: 1;
      display: flex;
      gap: 1rem;
      padding: 1.5rem;
      overflow: hidden;
    }

    .sequence-diagram {
      flex: 1;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: auto;
      box-shadow: var(--shadow-md);
      position: relative;
    }

    svg {
      display: block;
      width: 100%;
      height: 100%;
      min-height: 600px;
    }

    .box-3d {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .box-3d:hover .box-3d-front {
      fill: #004499;
      filter: brightness(1.1);
    }

    .box-3d-front {
      fill: #0066cc;
      transition: all 0.3s ease;
    }

    .box-3d-right {
      fill: #004499;
    }

    .box-3d-top {
      fill: #3b82f6;
    }

    .box-3d-text {
      fill: white;
      font-weight: bold;
      font-size: 14px;
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none;
      user-select: none;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .star {
      animation: twinkle 0.2s infinite;
      filter: drop-shadow(0 0 8px gold);
      pointer-events: none;
    }

    .message-line {
      stroke: #64748b;
      stroke-width: 2;
      fill: none;
    }

    .message-label {
      fill: #1e293b;
      font-size: 12px;
      text-anchor: middle;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }

    .message-label-bg {
      fill: white;
      stroke: #e2e8f0;
      stroke-width: 1;
      cursor: pointer;
    }

    .detail-panel {
      width: 300px;
      background: var(--bg-primary);
      border-left: 1px solid var(--border);
      border-radius: 8px;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
      padding: 1.5rem;
    }

    .detail-panel h3 {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.75rem;
    }

    .detail-item {
      margin-bottom: 1.25rem;
    }

    .detail-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: 0.35rem;
    }

    .detail-value {
      font-size: 0.9rem;
      color: var(--text-primary);
      padding: 0.5rem;
      background: var(--bg-secondary);
      border-radius: 4px;
      word-break: break-all;
      font-family: monospace;
      font-size: 0.8rem;
    }

    .empty-state {
      text-align: center;
      color: var(--text-tertiary);
      padding: 2rem;
    }

    @media (max-width: 1024px) {
      .diagram-wrapper {
        flex-direction: column;
      }
      .detail-panel {
        width: 100%;
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>IMS Call Flow Simulator</h1>
    <p>Interactive 3D sequence diagram</p>
  </header>

  <div class="main-container">
    <aside class="sidebar">
      <h2>Call Flow</h2>
      <div class="flow-selector">
        <select id="callType">
          <option value="">Select a flow...</option>
          <option value="Registration">IMS Registration</option>
          <option value="IMS OG Call">IMS Outgoing Call</option>
          <option value="IMS IC Call">IMS Incoming Call</option>
        </select>
      </div>
      <h2>Progress</h2>
      <div class="timeline" id="timeline"></div>
    </aside>

    <div class="content">
      <div class="toolbar">
        <button class="btn primary" id="nextBtn" disabled>â–¶ Next Step</button>
        <button class="btn" id="prevBtn" disabled>â†¶ Previous</button>
        <button class="btn" id="resetBtn" disabled>âŸ² Reset</button>
      </div>

      <div class="diagram-wrapper">
        <div class="sequence-diagram" id="diagram"></div>
        <div class="detail-panel" id="detailPanel">
          <div class="empty-state"><p>Click message lines for details</p></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CALL_FLOWS = {
      Registration: {
        participants: ["UE", "P-CSCF", "I-CSCF", "S-CSCF", "HSS"],
        messages: [
          { from: 0, to: 1, label: "REGISTER", details: { Protocol: "SIP", ImportantToSee: "IMPU,auth data, SIP instance", Port: "5060" } },
          { from: 1, to: 2, label: "REGISTER", details: { Protocol: "SIP", Auth: "Yes", Encryption: "TLS" } },
          { from: 2, to: 4, label: "UAR", details: { Protocol: "DIAMETER", ImportantToSee: "IMPU, User-Name, Visited Network-ID" } },
          { from: 4, to: 2, label: "UAA", details: { Protocol: "DIAMETER", ImportantToSee: "DIAMETER_FIRST_REGISTRATION in experimental result and SCSCF name or server capability list" } },
          { from: 2, to: 3, label: "REGISTER", details: { Protocol: "SIP", ImportantToSee: "S-CSCF assignment" } }
          { from: 3, to: 4, label: "MAR", details: { Protocol: "DIAMETER", ImportantToSee: "IMPU, Auth-Scheme, Visited Network-ID" } },
          { from: 4, to: 3, label: "MAA", details: { Protocol: "DIAMETER", ImportantToSee: "IMPU, Auth-Data, IMPI" } },
          { from: 3, to: 1, label: "401 Unthorized", details: { Protocol: "SIP", ImportantToSee: "Auth-Data,nonce,realm" } },
          { from: 1, to: 0, label: "401 Unthorized", details: { Protocol: "SIP", ImportantToSee: "Auth-Data,scheme, algorithm" } },
          { from: 0, to: 1, label: "REGISTER", details: { Protocol: "SIP", ImportantToSee: "Auth data(Auth Scheme,algorithm,intogrity protected,username, SIP instance)", Port: "5060" } },
          { from: 1, to: 2, label: "REGISTER", details: { Protocol: "SIP", Auth: "Yes", Encryption: "TLS" } },
          { from: 2, to: 4, label: "UAR", details: { Protocol: "DIAMETER", ImportantToSee: "IMPU, User-Name, Visited Network-ID" } },
          { from: 4, to: 2, label: "UAA", details: { Protocol: "DIAMETER", ImportantToSee: "DIAMETER_SUBSEQUENT_REGISTRATION in experimental result and Server name" } },
          { from: 2, to: 3, label: "REGISTER", details: { Protocol: "SIP", ImportantToSee: "S-CSCF assignment" } },
          { from: 3, to: 4, label: "SAR", details: { Protocol: "DIAMETER", ImportantToSee: "IMPU, Auth-Scheme, Servername" } },
          { from: 4, to: 3, label: "SAA", details: { Protocol: "DIAMETER", ImportantToSee: "IMPU, IFC" } },
          { from: 3, to: 1, label: "200 OK", details: { Protocol: "SIP", ImportantToSee: "Successful Registration" } },
          { from: 1, to: 0, label: "200 OK", details: { Protocol: "SIP", ImportantToSee: "Successful Registration" } }
          
        ]
      },
      "IMS OG Call": {
        participants: ["UE-A", "P-CSCF", "I-CSCF", "S-CSCF", "HSS", "UE-B"],
        messages: [
          { from: 0, to: 1, label: "INVITE", details: { Method: "INVITE", To: "UE-B" } },
          { from: 1, to: 2, label: "INVITE", details: { Protocol: "SIP", Compression: "SigComp" } },
          { from: 2, to: 4, label: "UAR", details: { Protocol: "DIAMETER", Purpose: "Routing" } },
          { from: 4, to: 2, label: "UAA", details: { Protocol: "DIAMETER", Status: "Found" } },
          { from: 2, to: 3, label: "INVITE", details: { Protocol: "SIP", Destination: "S-CSCF" } },
          { from: 3, to: 5, label: "INVITE", details: { Protocol: "SIP", Destination: "UE-B" } }
        ]
      },
      "IMS IC Call": {
        participants: ["UE-B", "P-CSCF", "I-CSCF", "S-CSCF", "HSS", "UE-A"],
        messages: [
          { from: 5, to: 3, label: "INVITE", details: { Protocol: "SIP", Direction: "Incoming", From: "UE-A" } },
          { from: 3, to: 2, label: "INVITE", details: { Protocol: "SIP", Purpose: "Route to I-CSCF" } },
          { from: 2, to: 4, label: "LIR", details: { Protocol: "DIAMETER", Purpose: "Location Info Request" } },
          { from: 4, to: 2, label: "LIA", details: { Protocol: "DIAMETER", Status: "Success" } },
          { from: 2, to: 1, label: "INVITE", details: { Protocol: "SIP", NextHop: "P-CSCF" } },
          { from: 1, to: 0, label: "INVITE", details: { Protocol: "SIP", Destination: "UE-B" } }
        ]
      }
    };

    let currentFlow = null;
    let currentStep = 0;
    const svgNS = "http://www.w3.org/2000/svg";

    // Event Listeners
    document.getElementById('callType').addEventListener('change', (e) => {
      currentFlow = e.target.value ? CALL_FLOWS[e.target.value] : null;
      currentStep = 0;
      document.getElementById('detailPanel').innerHTML = '<div class="empty-state"><p>Click message lines for details</p></div>';
      renderDiagram();
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentFlow && currentStep < currentFlow.messages.length) {
        animateStep();
      }
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        renderDiagram();
        updateButtons();
      }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      currentStep = 0;
      document.getElementById('detailPanel').innerHTML = '<div class="empty-state"><p>Click message lines for details</p></div>';
      renderDiagram();
      updateButtons();
    });

    function updateButtons() {
      document.getElementById('nextBtn').disabled = !currentFlow || currentStep >= currentFlow.messages.length;
      document.getElementById('prevBtn').disabled = currentStep === 0;
      document.getElementById('resetBtn').disabled = currentStep === 0;
    }

    function renderDiagram() {
      const diagram = document.getElementById('diagram');
      diagram.innerHTML = '';

      if (!currentFlow) {
        diagram.innerHTML = '<div class="empty-state"><p>Select a call flow to begin</p></div>';
        updateButtons();
        return;
      }

      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', '0 0 1400 900');
      svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
// ---------- ADD THIS BLOCK (ONCE) ----------
const defs = document.createElementNS(svgNS, 'defs');

const marker = document.createElementNS(svgNS, 'marker');
marker.setAttribute('id', 'arrow');
marker.setAttribute('markerWidth', '10');
marker.setAttribute('markerHeight', '10');
marker.setAttribute('refX', '9');
marker.setAttribute('refY', '3');
marker.setAttribute('orient', 'auto');
marker.setAttribute('markerUnits', 'strokeWidth');

const arrowPath = document.createElementNS(svgNS, 'path');
arrowPath.setAttribute('d', 'M0,0 L0,6 L9,3 z');
arrowPath.setAttribute('fill', '#64748b');

marker.appendChild(arrowPath);
defs.appendChild(marker);
svg.appendChild(defs);
// ---------- END ----------

      const boxWidth = 90;
      const boxHeight = 70;
      const spacing = 1400 / (currentFlow.participants.length + 1);
      const boxY = 40;

      // Store box positions for later use
      const boxPositions = {};

      // Draw 3D boxes
      currentFlow.participants.forEach((name, idx) => {
        const x = spacing * (idx + 1) - boxWidth / 2;
        boxPositions[idx] = { x: spacing * (idx + 1), y: boxY + boxHeight };

        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('class', 'box-3d');
        group.setAttribute('data-index', idx);

        // Check if this box is the source of the next message
        if (currentStep < currentFlow.messages.length && idx === currentFlow.messages[currentStep].from) {
          group.addEventListener('click', () => {
            if (currentStep < currentFlow.messages.length) {
              animateStep();
            }
          });

        }

        // Front face
        const front = document.createElementNS(svgNS, 'rect');
        front.setAttribute('class', 'box-3d-front');
        front.setAttribute('x', x);
        front.setAttribute('y', boxY);
        front.setAttribute('width', boxWidth);
        front.setAttribute('height', boxHeight);
        front.setAttribute('rx', 6);

        // Right face
        const right = document.createElementNS(svgNS, 'polygon');
        right.setAttribute('class', 'box-3d-right');
        right.setAttribute('points', `${x + boxWidth},${boxY} ${x + boxWidth + 8},${boxY - 8} ${x + boxWidth + 8},${boxY + boxHeight - 8} ${x + boxWidth},${boxY + boxHeight}`);

        // Top face
        const top = document.createElementNS(svgNS, 'polygon');
        top.setAttribute('class', 'box-3d-top');
        top.setAttribute('points', `${x},${boxY} ${x + 8},${boxY - 8} ${x + boxWidth + 8},${boxY - 8} ${x + boxWidth},${boxY}`);

        // Text
        const text = document.createElementNS(svgNS, 'text');
        text.setAttribute('class', 'box-3d-text');
        text.setAttribute('x', x + boxWidth / 2);
        text.setAttribute('y', boxY + boxHeight / 2);
        text.textContent = name;

        group.appendChild(front);
        group.appendChild(right);
        group.appendChild(top);
        group.appendChild(text);
        svg.appendChild(group);
      });

      // ================================
// VERTICAL LIFELINES (MSC STYLE)
// ================================
const lifelineTopY = boxY + boxHeight + 12;
const lifelineBottomY =
  180 + (currentFlow.messages.length - 1) * 80 + 60;

Object.values(boxPositions).forEach(pos => {
  const vLine = document.createElementNS(svgNS, 'line');
  vLine.setAttribute('x1', pos.x);
  vLine.setAttribute('y1', lifelineTopY);
  vLine.setAttribute('x2', pos.x);
  vLine.setAttribute('y2', lifelineBottomY);

  // ðŸ”¥ BOLD MSC STYLE
  vLine.setAttribute('stroke', '#334155');
  vLine.setAttribute('stroke-width', '3');
  vLine.setAttribute('shape-rendering', 'crispEdges');

  svg.appendChild(vLine);
});

      // Draw completed message lines
      for (let i = 0; i < currentStep; i++) {
        drawMessageLine(svg, currentFlow.messages[i], i, boxPositions);
      }

      diagram.appendChild(svg);
      updateButtons();
      updateTimeline();
    }

    function drawMessageLine(svg, msg, msgIdx, boxPositions) {
      const fromPos = boxPositions[msg.from];
      const toPos = boxPositions[msg.to];
      const baseY = 180 + msgIdx * 80;

      // Draw line
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('class', 'message-line');
      line.setAttribute('x1', fromPos.x);
      line.setAttribute('y1', baseY);
      line.setAttribute('x2', toPos.x);
      line.setAttribute('y2', baseY);
      line.setAttribute('marker-end', 'url(#arrow)');
      line.addEventListener('click', () => showDetail(msg));
      svg.appendChild(line);

      // Label background
      const midX = (fromPos.x + toPos.x) / 2;
      const labelBg = document.createElementNS(svgNS, 'rect');
      labelBg.setAttribute('class', 'message-label-bg');
      labelBg.setAttribute('x', midX - 75);
      labelBg.setAttribute('y', baseY - 20);
      labelBg.setAttribute('width', 150);
      labelBg.setAttribute('height', 24);
      labelBg.setAttribute('rx', 4);
      labelBg.addEventListener('click', () => showDetail(msg));
      svg.appendChild(labelBg);

      // Label text
      const label = document.createElementNS(svgNS, 'text');
      label.setAttribute('class', 'message-label');
      label.setAttribute('x', midX);
      label.setAttribute('y', baseY - 8);
      label.textContent = msg.label;
      label.addEventListener('click', () => showDetail(msg));
      svg.appendChild(label);
    }

    function animateStep() {
      if (currentStep >= currentFlow.messages.length) return;

      const msg = currentFlow.messages[currentStep];
      const svg = document.querySelector('svg');
      const spacing = 1400 / (currentFlow.participants.length + 1);
      const fromX = spacing * (msg.from + 1);
      const toX = spacing * (msg.to + 1);
      const baseY = 180 + currentStep * 80;

      // Create and add star
      const star = document.createElementNS(svgNS, 'polygon');
      star.setAttribute('class', 'star');
      star.setAttribute('points', '0,-5 1.5,-1.5 5,-1.5 2,1 3,5 0,2.5 -3,5 -2,1 -5,-1.5 -1.5,-1.5');
      star.setAttribute('fill', 'gold');

      svg.appendChild(star);

      const duration = 1200;
      const startTime = performance.now();

      function animate(timestamp) {
        const elapsed = timestamp - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Cubic easing
        const eased = 1 - Math.pow(1 - progress, 3);
        const x = fromX + (toX - fromX) * eased;

        star.setAttribute('transform', `translate(${x},${baseY})`);

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          star.remove();
          currentStep++;
          renderDiagram();
        }
      }

      requestAnimationFrame(animate);
    }

    function showDetail(msg) {
      const panel = document.getElementById('detailPanel');
      const fromName = currentFlow.participants[msg.from];
      const toName = currentFlow.participants[msg.to];

      panel.innerHTML = `
        <h3>Message Details</h3>
        <div class="detail-item">
          <div class="detail-label">Message</div>
          <div class="detail-value">${msg.label}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">From</div>
          <div class="detail-value">${fromName}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">To</div>
          <div class="detail-value">${toName}</div>
        </div>
        ${Object.entries(msg.details).map(([key, value]) => `
          <div class="detail-item">
            <div class="detail-label">${key}</div>
            <div class="detail-value">${value}</div>
          </div>
        `).join('')}
      `;
    }

    function updateTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '';

      if (!currentFlow) return;

      currentFlow.messages.forEach((msg, idx) => {
        const item = document.createElement('div');
        item.className = 'timeline-item';

        if (idx < currentStep) item.classList.add('completed');
        if (idx === currentStep) item.classList.add('active');

        item.textContent = `${idx + 1}. ${msg.label}`;
        item.addEventListener('click', () => {
          currentStep = idx;
          document.getElementById('detailPanel').innerHTML = '<div class="empty-state"><p>Click message lines for details</p></div>';
          renderDiagram();
        });

        timeline.appendChild(item);
      });
    }
  </script>
</body>
</html>
