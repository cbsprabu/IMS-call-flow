<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JSON Call Flow Upload</title>
<style>
  body { font-family: Arial; background: #eef2f5; }
  svg { background: #fff; border: 1px solid #ccc; }
  text { font-size: 12px; }
</style>
</head>
<body>

<h2>Upload Call Flow JSON</h2>

<input type="file" id="jsonFile" accept=".json">
<div id="diagram"></div>

<script>
document.getElementById("jsonFile").addEventListener("change", loadJSON);

function loadJSON(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const flow = JSON.parse(e.target.result);
      drawFlow(flow);
    } catch {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
}

function drawFlow(flow) {
  const colGap = 150;
  const startX = 70;
  const startY = 80;
  const msgGap = 50;

  const height = flow.messages.length * msgGap + 140;
  let svg = `
  <svg width="1100" height="${height}">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10"
              refX="10" refY="5" orient="auto">
        <path d="M0,0 L10,5 L0,10 Z" fill="black"/>
      </marker>
    </defs>
  `;

  /* Lifelines */
  flow.nodes.forEach((node, i) => {
    const x = startX + i * colGap;
    svg += `
      <text x="${x - 15}" y="30">${node}</text>
      <line x1="${x}" y1="40" x2="${x}" y2="${height - 20}" stroke="#aaa"/>
    `;
  });

  /* Messages */
  flow.messages.forEach((m, i) => {
    const y = startY + i * msgGap;
    const fromX = startX + flow.nodes.indexOf(m.from) * colGap;
    const toX   = startX + flow.nodes.indexOf(m.to) * colGap;

    svg += `
      <line x1="${fromX}" y1="${y}" x2="${toX}" y2="${y}"
            stroke="black" marker-end="url(#arrow)"/>

      <text x="${(fromX + toX) / 2 - 40}" y="${y - 5}">
        ${m.text.map((t, j) =>
          `<tspan x="${(fromX + toX) / 2 - 40}" dy="${j === 0 ? 0 : 14}">${t}</tspan>`
        ).join("")}
      </text>
    `;
  });

  svg += `</svg>`;
  document.getElementById("diagram").innerHTML = svg;
}
</script>

</body>
</html>
